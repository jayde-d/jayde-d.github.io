<!DOCTYPE html>
<html>
	<head>
	    <meta charset="utf-8" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
	</head>
	<body>
	<h1>Test Page</h1>
	<ul id="myList">
	<script>
		window.onload = function() {
		
		var queryString = window.location.search;
		var urlParams = new URLSearchParams(queryString);
		
		var seed = urlParams.get("seed");
		var dir = urlParams.get("directory");
		if(dir == null)
		{
			window.alert("This page doesn't run correctly if you don't directly come from the zine generator!")
			//return;
		}
		else
		{
		
			var splitDir = dir.split("/");
			
			console.log(seed);
			console.log(dir)
			
			console.log(splitDir[2]+"/"+splitDir[3]);
			
			var DBOpenRequest = window.indexedDB.open("/idbfs");
			var db;
			var objects = new Array();
			var images = new Array();
			var allKeys = new Array();
			var keys = new Array();


			DBOpenRequest.onsuccess = function(event) {
				console.log("SUCCESS!");
				db = DBOpenRequest.result;
				var transaction = db.transaction("FILE_DATA", "readwrite");
				
				var objectStore = transaction.objectStore("FILE_DATA");
				var objectsRequest = objectStore.getAll();
				allKeys = objectStore.getAllKeys();
				
				objectsRequest.onsuccess = function()
				{
					objects = objectsRequest.result;
					//console.log(objects);
					objects.forEach(addToImages);
				}
			}

			
			function addToImages (item, index)
			{
				if(item.mode == 33206)
				{
					//keys.push(allKeys[index]);
					images.push(item.contents);
				}
				
			}
			
			//console.log("allkeys: ");
			//console.log(allKeys);
			//console.log("keys : ");
			//console.log(keys);
			console.log(images);
		}
		
		
		if(images == null)
		{
			window.alert("No images to insert into PDF!");
			return;
		}
		
		
		const { jsPDF } = window.jspdf;
		
		// Default export is a4 paper, portrait, using millimeters for units
		const doc = new jsPDF();

		doc.setDrawColor(128, 128, 128); // draw grey lines
		doc.setLineWidth(0.1);
		 
		doc.line(105, 1, 105, 74.25);
		doc.line(105, 222.75, 105, 297);
		
		// 0
		doc.line(1, 74.25, 209, 74.25);
		doc.line(1, 148.5, 209, 148.5);
		doc.line(1, 222.75, 209, 222.75);
		// 297
		
		doc.setLineDashPattern([2.5]);
		//doc.setLineWidth(0.5);
		//doc.line(105, 20, 105, 277);
		doc.line(105, 74.25, 105, 222.75);
		doc.rect(1, 1, 208, 295);
		
		
		var testimage = new Image();
		testimage.src = "testimage.png";
		//doc.addImage(testimage, "PNG ", 2.5, 7.125, 90, 60);
		doc.addImage(images[1], "PNG", 5, 229.875, 90, 60);
		
		doc.addImage(images[2] , "PNG", 120, 229.875, 90, 60, null, null, 180);
		
		
		doc.addImage(images[6], "PNG", 5, 7.125, 90, 60);
		doc.addImage(images[7], "PNG", 5, 81.375, 90, 60);
		doc.addImage(images[8], "PNG", 5, 155.625, 90, 60);
		
		
		doc.setFontSize(6);
		
		doc.text("1", 100, 259.875, align = "center" , rotate = 0);
		doc.text("2", 110, 259.875, align = "center" , rotate = 180);
		doc.text("3", 110, 185.625, align = "center" , rotate = 180);
		doc.text("4", 110, 111.375, align = "center" , rotate = 180);
		doc.text("5", 110, 37.125, align = "center" , rotate = 180);
		doc.text("6", 100, 37.125, align = "center" , rotate = 0);
		doc.text("7", 100, 111.375, align = "center" , rotate = 0);
		doc.text("8", 100, 185.625, align = "center" , rotate = 0);
		
		//END
		doc.save("ZINE.pdf");

		}
	</script>
	</body>
</html>